<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Authorization Testing Automation - OWASP Cheat Sheet Series</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Authorization Testing Automation";
    var mkdocs_page_input_path = "cheatsheets/Authorization_Testing_Automation.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> OWASP Cheat Sheet Series</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../IndexASVS/">Index ASVS</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../IndexProactiveControls/">Index Proactive Controls</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../glossary/">Index Alphabetical</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Cheatsheets</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../AJAX_Security_Cheat_Sheet/">AJAX Security Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Abuse_Case_Cheat_Sheet/">Abuse Case Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Access_Control_Cheat_Sheet/">Access Control Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Attack_Surface_Analysis_Cheat_Sheet/">Attack Surface Analysis Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Authentication_Cheat_Sheet/">Authentication Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Authorization Testing Automation</a>
    <ul class="current">
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Bean_Validation_Cheat_Sheet/">Bean Validation Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../C-Based_Toolchain_Hardening/">C-Based Toolchain Hardening</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../C-Based_Toolchain_Hardening_Cheat_Sheet/">C-Based Toolchain Hardening Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Choosing_and_Using_Security_Questions_Cheat_Sheet/">Choosing and Using Security Questions Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Clickjacking_Defense_Cheat_Sheet/">Clickjacking Defense Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Content_Security_Policy_Cheat_Sheet/">Content Security Policy Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Credential_Stuffing_Prevention_Cheat_Sheet/">Credential Stuffing Prevention Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Cross-Site_Request_Forgery_Prevention_Cheat_Sheet/">Cross-Site Request Forgery Prevention Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Cross_Site_Scripting_Prevention_Cheat_Sheet/">Cross Site Scripting Prevention Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Cryptographic_Storage_Cheat_Sheet/">Cryptographic Storage Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../DOM_based_XSS_Prevention_Cheat_Sheet/">DOM based XSS Prevention Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Database_Security_Cheat_Sheet/">Database Security Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Denial_of_Service_Cheat_Sheet/">Denial of Service Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Deserialization_Cheat_Sheet/">Deserialization Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Docker_Security_Cheat_Sheet/">Docker Security Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../DotNet_Security_Cheat_Sheet/">DotNet Security Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Error_Handling_Cheat_Sheet/">Error Handling Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../File_Upload_Cheat_Sheet/">File Upload Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Forgot_Password_Cheat_Sheet/">Forgot Password Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../HTML5_Security_Cheat_Sheet/">HTML5 Security Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../HTTP_Strict_Transport_Security_Cheat_Sheet/">HTTP Strict Transport Security Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Injection_Prevention_Cheat_Sheet/">Injection Prevention Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Injection_Prevention_Cheat_Sheet_in_Java/">Injection Prevention Cheat Sheet in Java</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Input_Validation_Cheat_Sheet/">Input Validation Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Insecure_Direct_Object_Reference_Prevention_Cheat_Sheet/">Insecure Direct Object Reference Prevention Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../JAAS_Cheat_Sheet/">JAAS Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../JSON_Web_Token_Cheat_Sheet_for_Java/">JSON Web Token Cheat Sheet for Java</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Key_Management_Cheat_Sheet/">Key Management Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../LDAP_Injection_Prevention_Cheat_Sheet/">LDAP Injection Prevention Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Logging_Cheat_Sheet/">Logging Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Mass_Assignment_Cheat_Sheet/">Mass Assignment Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Microservices_based_Security_Arch_Doc_Cheat_Sheet/">Microservices based Security Arch Doc Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Multifactor_Authentication_Cheat_Sheet/">Multifactor Authentication Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Nodejs_security_cheat_sheet/">Nodejs security cheat sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../OS_Command_Injection_Defense_Cheat_Sheet/">OS Command Injection Defense Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../PHP_Configuration_Cheat_Sheet/">PHP Configuration Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Password_Storage_Cheat_Sheet/">Password Storage Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Pinning_Cheat_Sheet/">Pinning Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Query_Parameterization_Cheat_Sheet/">Query Parameterization Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../REST_Assessment_Cheat_Sheet/">REST Assessment Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../REST_Security_Cheat_Sheet/">REST Security Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Ruby_on_Rails_Cheatsheet/">Ruby on Rails Cheatsheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../SAML_Security_Cheat_Sheet/">SAML Security Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../SQL_Injection_Prevention_Cheat_Sheet/">SQL Injection Prevention Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Securing_Cascading_Style_Sheets_Cheat_Sheet/">Securing Cascading Style Sheets Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Server_Side_Request_Forgery_Prevention_Cheat_Sheet/">Server Side Request Forgery Prevention Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Session_Management_Cheat_Sheet/">Session Management Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../TLS_Cipher_String_Cheat_Sheet/">TLS Cipher String Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Third_Party_Javascript_Management_Cheat_Sheet/">Third Party Javascript Management Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Threat_Modeling_Cheat_Sheet/">Threat Modeling Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Transaction_Authorization_Cheat_Sheet/">Transaction Authorization Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Transport_Layer_Protection_Cheat_Sheet/">Transport Layer Protection Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Unvalidated_Redirects_and_Forwards_Cheat_Sheet/">Unvalidated Redirects and Forwards Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../User_Privacy_Protection_Cheat_Sheet/">User Privacy Protection Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Virtual_Patching_Cheat_Sheet/">Virtual Patching Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Vulnerability_Disclosure_Cheat_Sheet/">Vulnerability Disclosure Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Vulnerable_Dependency_Management_Cheat_Sheet/">Vulnerable Dependency Management Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Web_Service_Security_Cheat_Sheet/">Web Service Security Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../XML_External_Entity_Prevention_Cheat_Sheet/">XML External Entity Prevention Cheat Sheet</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../XML_Security_Cheat_Sheet/">XML Security Cheat Sheet</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">OWASP Cheat Sheet Series</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Cheatsheets &raquo;</li>
        
      
    
    <li>Authorization Testing Automation</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h1>
<p>Authorizations definition and implementation is one of the important protection measure of an application. They are defined in the creation phase of the project and, even if authorization issues are found when the application is initially released and submitted to a security audit before to go live, the most significant number of issues related to authorization came in the maintenance lifetime of the application.</p>
<p>This situation is often explained by the fact that features are added/modified and no review of the authorizations was performed on the application before the publishing of the new release, for cost or time issue reason.</p>
<h1 id="context">Context<a class="headerlink" href="#context" title="Permanent link">&para;</a></h1>
<p>In order to try to address this situation, it's can be interesting to automate the evaluation of the authorizations definition and implementation on the application. This, to constantly ensure that implementation of the authorizations in the application is consistent with the authorizations definition.</p>
<p>An authorization is often composed by 2 elements (also named dimensions): The <strong>Feature</strong> and the <strong>Logical Role</strong> that can access it (sometime a third dimension named <strong>Data</strong> is added in order to define a access that include a filtering at business data level).</p>
<p>The representation of the different combinations of these 2 dimensions is often named an <strong>Authorization matrix</strong> and is often formalized in an Microsoft Excel file.</p>
<p>During a test of an authorization, a <strong>Logical Role</strong> is also called a <strong>Point Of View</strong>.</p>
<h1 id="objective">Objective<a class="headerlink" href="#objective" title="Permanent link">&para;</a></h1>
<p>This article describe a proposition of implementation in order to automate the tests of an <em>authorization matrix</em>.</p>
<p>This article use the assumption that 2 dimensions are used to represents an authorization for the technical proposition described and take as example a application exposing REST services.</p>
<p>The objective is to provide starting ideas/hints in order to create a tailored way of testing of the authorization matrix for the target application.</p>
<h1 id="proposition">Proposition<a class="headerlink" href="#proposition" title="Permanent link">&para;</a></h1>
<p>In order to achieve the full automation of the evaluation of the <em>authorization matrix</em>, the following actions has been performed:</p>
<ol>
<li>
<p>Formalize the authorization matrix in a pivot format file allowing:</p>
<ol>
<li>The processing by a program in a easy way.</li>
<li>To be read and updated by a human for the follow-up of the authorization combinations.</li>
<li>Hierarchy in the information in order to easily materialize the different combinations.</li>
<li>The maximum possible of independence from the technology and design used to implements the application exposing the features.</li>
</ol>
</li>
<li>
<p>Create a set of integration tests that fully use the authorization matrix pivot file as input source in order to evaluate the different combinations with:</p>
<ol>
<li>The minimum possible of maintenance when the authorization matrix pivot file is updated.</li>
<li>A clear indication, in case of failed test, of the source authorization combination that do not respect the authorization matrix.</li>
</ol>
</li>
</ol>
<h2 id="authorization-matrix-pivot-file">Authorization matrix pivot file<a class="headerlink" href="#authorization-matrix-pivot-file" title="Permanent link">&para;</a></h2>
<p>The XML format has been used to formalize the authorization matrix.</p>
<p>The XML structure contains 3 main sections:</p>
<ul>
<li>Node <strong>roles</strong>: This node describe the possible logical roles used in the system, is used to provide a list and the explanation of the different roles (authorization level).</li>
<li>Node <strong>services</strong>: This node list and describe the available services exposed by the system and the associated logical role(s) that can call them.</li>
<li>Node <strong>services-testing</strong>: This node provide a test payload for each service if the service use input data other than coming from url or path.</li>
</ul>
<p>This is an example of the XML used to represents the authorization:</p>
<p><em>Placeholders (values between {}) are used to mark location where test value must be placed by the integration tests if needed</em></p>
<pre><code class="xml">  &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
  &lt;!--
      This file materialize the authorization matrix for the different 
      services exposed by the system.

      It will be used by the tests as a input sources for the different tests cases:
      1) Evaluate legitimate access and is correct implementation
      2) Identify not legitimate access (authorization definition issue 
      on service implementation)

      The &quot;name&quot; attribute is used for identify uniquely a SERVICE or a ROLE.
  --&gt;
  &lt;authorization-matrix&gt;

      &lt;!-- Describe the possible logical roles used in the system, is used here to 
      provide a list+explanation
      of the different roles (authorization level) --&gt;
      &lt;roles&gt;
          &lt;role name=&quot;ANONYMOUS&quot; 
          description=&quot;Indicate that no authorization is needed&quot;/&gt;
          &lt;role name=&quot;BASIC&quot; 
          description=&quot;Role affected to a standard user (lowest access right just above anonymous)&quot;/&gt;
          &lt;role name=&quot;ADMIN&quot; 
          description=&quot;Role affected to a administrator user (highest access right)&quot;/&gt;
      &lt;/roles&gt;

      &lt;!-- List and describe the available services exposed by the system and the associated 
      logical role(s) that can call them --&gt;
      &lt;services&gt;
          &lt;service name=&quot;ReadSingleMessage&quot; uri=&quot;/{messageId}&quot; http-method=&quot;GET&quot; 
          http-response-code-for-access-allowed=&quot;200&quot; http-response-code-for-access-denied=&quot;403&quot;&gt;
              &lt;role name=&quot;ANONYMOUS&quot;/&gt;
              &lt;role name=&quot;BASIC&quot;/&gt;
              &lt;role name=&quot;ADMIN&quot;/&gt;
          &lt;/service&gt;
          &lt;service name=&quot;ReadAllMessages&quot; uri=&quot;/&quot; http-method=&quot;GET&quot; 
          http-response-code-for-access-allowed=&quot;200&quot; http-response-code-for-access-denied=&quot;403&quot;&gt;
              &lt;role name=&quot;ANONYMOUS&quot;/&gt;
              &lt;role name=&quot;BASIC&quot;/&gt;
              &lt;role name=&quot;ADMIN&quot;/&gt;
          &lt;/service&gt;
          &lt;service name=&quot;CreateMessage&quot; uri=&quot;/&quot; http-method=&quot;PUT&quot; 
          http-response-code-for-access-allowed=&quot;200&quot; http-response-code-for-access-denied=&quot;403&quot;&gt;
              &lt;role name=&quot;BASIC&quot;/&gt;
              &lt;role name=&quot;ADMIN&quot;/&gt;
          &lt;/service&gt;
          &lt;service name=&quot;DeleteMessage&quot; uri=&quot;/{messageId}&quot; http-method=&quot;DELETE&quot; 
          http-response-code-for-access-allowed=&quot;200&quot; http-response-code-for-access-denied=&quot;403&quot;&gt;
              &lt;role name=&quot;ADMIN&quot;/&gt;
          &lt;/service&gt;
      &lt;/services&gt;

      &lt;!-- Provide a test payload for each service if needed --&gt;
      &lt;services-testing&gt;
          &lt;service name=&quot;ReadSingleMessage&quot;&gt;
              &lt;payload/&gt;
          &lt;/service&gt;
          &lt;service name=&quot;ReadAllMessages&quot;&gt;
              &lt;payload/&gt;
          &lt;/service&gt;
          &lt;service name=&quot;CreateMessage&quot;&gt;
              &lt;payload content-type=&quot;application/json&quot;&gt;
                  {&quot;content&quot;:&quot;test&quot;}
              &lt;/payload&gt;
          &lt;/service&gt;
          &lt;service name=&quot;DeleteMessage&quot;&gt;
              &lt;payload/&gt;
          &lt;/service&gt;
      &lt;/services-testing&gt;

  &lt;/authorization-matrix&gt;
</code></pre>

<h2 id="integration-tests">Integration tests<a class="headerlink" href="#integration-tests" title="Permanent link">&para;</a></h2>
<p>Integration tests are implemented using a maximum of factorized code and one test case by <strong>Point Of View (POV)</strong> has been created in order to group the verifications by profile of access level (logical role) and facilitate the rendering/identification of the errors.</p>
<p>Parsing, object mapping and access to the authorization matrix information has been implemented using XML marshalling/unmarshalling built-in features provided by the technology used to implements the tests (JAXB here) in order to limit the code to the one in charge of performing the tests.</p>
<p>This the implementation of the integration tests case class:</p>
<pre><code class="java">  import org.owasp.pocauthztesting.enumeration.SecurityRole;
  import org.owasp.pocauthztesting.service.AuthService;
  import org.owasp.pocauthztesting.vo.AuthorizationMatrix;
  import org.apache.http.client.methods.CloseableHttpResponse;
  import org.apache.http.client.methods.HttpDelete;
  import org.apache.http.client.methods.HttpGet;
  import org.apache.http.client.methods.HttpPut;
  import org.apache.http.client.methods.HttpRequestBase;
  import org.apache.http.entity.StringEntity;
  import org.apache.http.impl.client.CloseableHttpClient;
  import org.apache.http.impl.client.HttpClients;
  import org.junit.Assert;
  import org.junit.BeforeClass;
  import org.junit.Test;
  import org.xml.sax.InputSource;
  import javax.xml.bind.JAXBContext;
  import javax.xml.parsers.SAXParserFactory;
  import javax.xml.transform.Source;
  import javax.xml.transform.sax.SAXSource;
  import java.io.File;
  import java.io.FileInputStream;
  import java.util.ArrayList;
  import java.util.List;
  import java.util.Optional;

  /**
   * Integration Test cases in charge of validate the correct implementation of the authorization matrix.
   * Create on test case by logical role that will test access on all services exposed by the system.
   * Implements here focus on readability
   */
  public class AuthorizationMatrixIT {

      /**
       * Object representation of the authorization matrix
       */
      private static AuthorizationMatrix AUTHZ_MATRIX;

      private static final String BASE_URL = &quot;http://localhost:8080&quot;;


      /**
       * Load the authorization matrix in objects tree
       *
       * @throws Exception If any error occurs
       */
      @BeforeClass
      public static void globalInit() throws Exception {
          try (FileInputStream fis = new FileInputStream(new File(&quot;authorization-matrix.xml&quot;))) { 
              SAXParserFactory spf = SAXParserFactory.newInstance();
              spf.setFeature(&quot;http://xml.org/sax/features/external-general-entities&quot;, false);
              spf.setFeature(&quot;http://xml.org/sax/features/external-parameter-entities&quot;, false);
              spf.setFeature(&quot;http://apache.org/xml/features/nonvalidating/load-external-dtd&quot;, false);
              Source xmlSource = new SAXSource(spf.newSAXParser().getXMLReader(), new InputSource(fis));
              JAXBContext jc = JAXBContext.newInstance(AuthorizationMatrix.class);
              AUTHZ_MATRIX = (AuthorizationMatrix) jc.createUnmarshaller().unmarshal(xmlSource);
          }
      }

      /**
       * Test access to the services from a anonymous user.
       *
       * @throws Exception
       */
      @Test
      public void testAccessUsingAnonymousUserPointOfView() throws Exception {
          //Run the tests - No access token here
          List&lt;String&gt; errors = executeTestWithPointOfView(SecurityRole.ANONYMOUS, null);
          //Verify the test results
          Assert.assertEquals(&quot;Access issues detected using the ANONYMOUS USER point of view:\n&quot; + formatErrorsList(errors), 0, errors.size());
      }

      /**
       * Test access to the services from a basic user.
       *
       * @throws Exception
       */
      @Test
      public void testAccessUsingBasicUserPointOfView() throws Exception {
          //Get access token representing the authorization for the associated point of view
          String accessToken = generateTestCaseAccessToken(&quot;basic&quot;, SecurityRole.BASIC);
          //Run the tests
          List&lt;String&gt; errors = executeTestWithPointOfView(SecurityRole.BASIC, accessToken);
          //Verify the test results
          Assert.assertEquals(&quot;Access issues detected using the BASIC USER point of view:\n &quot; + formatErrorsList(errors), 0, errors.size());
      }

      /**
       * Test access to the services from a administrator user.
       *
       * @throws Exception
       */
      @Test
      public void testAccessUsingAdministratorUserPointOfView() throws Exception {
          //Get access token representing the authorization for the associated point of view
          String accessToken = generateTestCaseAccessToken(&quot;admin&quot;, SecurityRole.ADMIN);
          //Run the tests
          List&lt;String&gt; errors = executeTestWithPointOfView(SecurityRole.ADMIN, accessToken);
          //Verify the test results
          Assert.assertEquals(&quot;Access issues detected using the ADMIN USER point of view:\n&quot; + formatErrorsList(errors), 0, errors.size());
      }

      /**
       * Evaluate the access to all service using the point of view (POV) specified.
       *
       * @param pointOfView Point of view to use
       * @param accessToken Access token that is linked to the point of view in terms of authorization.
       * @return List of errors detected
       * @throws Exception If any error occurs
       */
      private List&lt;String&gt; executeTestWithPointOfView(SecurityRole pointOfView, String accessToken) throws Exception {
          List&lt;String&gt; errors = new ArrayList&lt;&gt;();
          String errorMessageTplForUnexpectedReturnCode = &quot;The service '%s' when called with POV '%s' return a response code %s that is not the expected one in allowed or denied case.&quot;;
          String errorMessageTplForIncorrectReturnCode = &quot;The service '%s' when called with POV '%s' return a response code %s that is not the expected one (%s expected).&quot;;
          String fatalErrorMessageTpl = &quot;The service '%s' when called with POV %s meet the error: %s&quot;;

          //Get the list of services to call
          List&lt;AuthorizationMatrix.Services.Service&gt; services = AUTHZ_MATRIX.getServices().getService();

          //Get the list of services test payload to use
          List&lt;AuthorizationMatrix.ServicesTesting.Service&gt; servicesTestPayload = AUTHZ_MATRIX.getServicesTesting().getService();

          //Call all services sequentially (no special focus on performance here)
          services.forEach(service -&gt; {
              //Get the service test payload for the current service
              String payload = null;
              String payloadContentType = null;
              Optional&lt;AuthorizationMatrix.ServicesTesting.Service&gt; serviceTesting = servicesTestPayload.stream().filter(srvPld -&gt; srvPld.getName().equals(service.getName())).findFirst();
              if (serviceTesting.isPresent()) {
                  payload = serviceTesting.get().getPayload().getValue();
                  payloadContentType = serviceTesting.get().getPayload().getContentType();
              }
              //Call the service and verify if the response is consistent
              try {
                  //Call the service
                  int serviceResponseCode = callService(service.getUri(), payload, payloadContentType, service.getHttpMethod(), accessToken);
                  //Check if the role represented by the specified point of view is defined for the current service
                  Optional&lt;AuthorizationMatrix.Services.Service.Role&gt; role = service.getRole().stream().filter(r -&gt; r.getName().equals(pointOfView.name())).findFirst();
                  boolean accessIsGrantedInAuthorizationMatrix = role.isPresent();
                  //Verify behavior consistency according to the response code returned and the authorization configured in the matrix
                  if (serviceResponseCode == service.getHttpResponseCodeForAccessAllowed()) {
                      //Roles is not in the list of role allowed to access to the service so it's an error
                      if (!accessIsGrantedInAuthorizationMatrix) {
                          errors.add(String.format(errorMessageTplForIncorrectReturnCode, service.getName(), pointOfView.name(), serviceResponseCode,
                           service.getHttpResponseCodeForAccessDenied()));
                      }
                  } else if (serviceResponseCode == service.getHttpResponseCodeForAccessDenied()) {
                      //Roles is in the list of role allowed to access to the service so it's an error
                      if (accessIsGrantedInAuthorizationMatrix) {
                          errors.add(String.format(errorMessageTplForIncorrectReturnCode, service.getName(), pointOfView.name(), serviceResponseCode,
                           service.getHttpResponseCodeForAccessAllowed()));
                      }
                  } else {
                      errors.add(String.format(errorMessageTplForUnexpectedReturnCode, service.getName(), pointOfView.name(), serviceResponseCode));
                  }
              } catch (Exception e) {
                  errors.add(String.format(fatalErrorMessageTpl, service.getName(), pointOfView.name(), e.getMessage()));
              }


          });

          return errors;
      }

      /**
       * Call a service with a specific payload and return the HTTP response code received.
       * Delegate this step in order to made the test cases more easy to maintain.
       *
       * @param uri                URI of the target service
       * @param payloadContentType Content type of the payload to send
       * @param payload            Payload to send
       * @param httpMethod         HTTP method to use
       * @param accessToken        Access token to specify to represent the identity of the caller
       * @return The HTTP response code received
       * @throws Exception If any error occurs
       */
      private int callService(String uri, String payload, String payloadContentType, String httpMethod, String accessToken) throws Exception {
          int rc;

          //Build the request - Use Apache HTTP Client in order to be more flexible in the combination
          HttpRequestBase request;
          String url = (BASE_URL + uri).replaceAll(&quot;\\{messageId\\}&quot;, &quot;1&quot;);
          switch (httpMethod) {
              case &quot;GET&quot;:
                  request = new HttpGet(url);
                  break;
              case &quot;DELETE&quot;:
                  request = new HttpDelete(url);
                  break;
              case &quot;PUT&quot;:
                  request = new HttpPut(url);
                  if (payload != null) {
                      request.setHeader(&quot;Content-Type&quot;, payloadContentType);
                      ((HttpPut) request).setEntity(new StringEntity(payload.trim()));
                  }
                  break;
              default:
                  throw new UnsupportedOperationException(httpMethod + &quot; not supported !&quot;);
          }
          request.setHeader(&quot;Authorization&quot;, (accessToken != null) ? accessToken : &quot;&quot;);


          //Send the request and get the HTTP response code
          try (CloseableHttpClient httpClient = HttpClients.createDefault()) {
              try (CloseableHttpResponse httpResponse = httpClient.execute(request)) {
                  //Don't care here about the response content...
                  rc = httpResponse.getStatusLine().getStatusCode();
              }
          }

          return rc;
      }

      /**
       * Generate a JWT token the user and role specified.
       *
       * @param login User login
       * @param role  Authorization logical role
       * @return The JWT token
       * @throws Exception If any error occurs during the creation
       */
      private String generateTestCaseAccessToken(String login, SecurityRole role) throws Exception {
          return new AuthService().issueAccessToken(login, role);
      }


      /**
       * Format a list of errors to a printable string
       *
       * @param errors Error list
       * @return Printable string
       */
      private String formatErrorsList(List&lt;String&gt; errors) {
          StringBuilder buffer = new StringBuilder();
          errors.forEach(e -&gt; buffer.append(e).append(&quot;\n&quot;));
          return buffer.toString();
      }
  }
</code></pre>

<p>In case of detection of a authorization issue(s) the output is the following:</p>
<pre><code>testAccessUsingAnonymousUserPointOfView(org.owasp.pocauthztesting.AuthorizationMatrixIT)  
Time elapsed: 1.009 s  ### FAILURE
java.lang.AssertionError:
Access issues detected using the ANONYMOUS USER point of view:
    The service 'DeleteMessage' when called with POV 'ANONYMOUS' return 
    a response code 200 that is not the expected one (403 expected).

    The service 'CreateMessage' when called with POV 'ANONYMOUS' return 
    a response code 200 that is not the expected one (403 expected).

testAccessUsingBasicUserPointOfView(org.owasp.pocauthztesting.AuthorizationMatrixIT)  
Time elapsed: 0.05 s  ### FAILURE!
java.lang.AssertionError:
Access issues detected using the BASIC USER point of view:
    The service 'DeleteMessage' when called with POV 'BASIC' return 
    a response code 200 that is not the expected one (403 expected).
</code></pre>

<h1 id="rendering-of-the-authorization-matrix-for-audit-review">Rendering of the authorization matrix for audit / review<a class="headerlink" href="#rendering-of-the-authorization-matrix-for-audit-review" title="Permanent link">&para;</a></h1>
<p>Even if the authorization matrix is stored in a human readable format (XML), it can be interesting to provide an on-the-fly rendering representation of the XML file in order to facilitate the review, audit and discussion about the authorization matrix in order to spot potential inconsistencies.</p>
<p>The Following XSL stylesheet can be used:</p>
<pre><code class="xslt">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;xsl:stylesheet xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot; version=&quot;1.0&quot;&gt;
  &lt;xsl:template match=&quot;/&quot;&gt;
    &lt;html&gt;
      &lt;head&gt;
        &lt;title&gt;Authorization Matrix&lt;/title&gt;
        &lt;link rel=&quot;stylesheet&quot; 
        href=&quot;https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css&quot; 
        integrity=&quot;sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ&quot; 
        crossorigin=&quot;anonymous&quot; /&gt;
      &lt;/head&gt;
      &lt;body&gt;
        &lt;h3&gt;Roles&lt;/h3&gt;
        &lt;ul&gt;
          &lt;xsl:for-each select=&quot;authorization-matrix/roles/role&quot;&gt;
            &lt;xsl:choose&gt;
              &lt;xsl:when test=&quot;@name = 'ADMIN'&quot;&gt;
                &lt;div class=&quot;alert alert-warning&quot; role=&quot;alert&quot;&gt;
                  &lt;strong&gt;
                    &lt;xsl:value-of select=&quot;@name&quot; /&gt;
                  &lt;/strong&gt;
                  :
                  &lt;xsl:value-of select=&quot;@description&quot; /&gt;
                &lt;/div&gt;
              &lt;/xsl:when&gt;
              &lt;xsl:when test=&quot;@name = 'BASIC'&quot;&gt;
                &lt;div class=&quot;alert alert-info&quot; role=&quot;alert&quot;&gt;
                  &lt;strong&gt;
                    &lt;xsl:value-of select=&quot;@name&quot; /&gt;
                  &lt;/strong&gt;
                  :
                  &lt;xsl:value-of select=&quot;@description&quot; /&gt;
                &lt;/div&gt;
              &lt;/xsl:when&gt;
              &lt;xsl:otherwise&gt;
                &lt;div class=&quot;alert alert-danger&quot; role=&quot;alert&quot;&gt;
                  &lt;strong&gt;
                    &lt;xsl:value-of select=&quot;@name&quot; /&gt;
                  &lt;/strong&gt;
                  :
                  &lt;xsl:value-of select=&quot;@description&quot; /&gt;
                &lt;/div&gt;
              &lt;/xsl:otherwise&gt;
            &lt;/xsl:choose&gt;
          &lt;/xsl:for-each&gt;
        &lt;/ul&gt;
        &lt;h3&gt;Authorizations&lt;/h3&gt;
        &lt;table class=&quot;table table-hover table-sm&quot;&gt;
          &lt;thead class=&quot;thead-inverse&quot;&gt;
            &lt;tr&gt;
              &lt;th&gt;Service&lt;/th&gt;
              &lt;th&gt;URI&lt;/th&gt;
              &lt;th&gt;Method&lt;/th&gt;
              &lt;th&gt;Role&lt;/th&gt;
            &lt;/tr&gt;
          &lt;/thead&gt;
          &lt;tbody&gt;
            &lt;xsl:for-each select=&quot;authorization-matrix/services/service&quot;&gt;
              &lt;xsl:variable name=&quot;service-name&quot; select=&quot;@name&quot; /&gt;
              &lt;xsl:variable name=&quot;service-uri&quot; select=&quot;@uri&quot; /&gt;
              &lt;xsl:variable name=&quot;service-method&quot; select=&quot;@http-method&quot; /&gt;
              &lt;xsl:for-each select=&quot;role&quot;&gt;
                &lt;tr&gt;
                  &lt;td scope=&quot;row&quot;&gt;
                    &lt;xsl:value-of select=&quot;$service-name&quot; /&gt;
                  &lt;/td&gt;
                  &lt;td&gt;
                    &lt;xsl:value-of select=&quot;$service-uri&quot; /&gt;
                  &lt;/td&gt;
                  &lt;td&gt;
                    &lt;xsl:value-of select=&quot;$service-method&quot; /&gt;
                  &lt;/td&gt;
                  &lt;td&gt;
                    &lt;xsl:variable name=&quot;service-role-name&quot; select=&quot;@name&quot; /&gt;
                    &lt;xsl:choose&gt;
                      &lt;xsl:when test=&quot;@name = 'ADMIN'&quot;&gt;
                        &lt;div class=&quot;alert alert-warning&quot; role=&quot;alert&quot;&gt;
                          &lt;xsl:value-of select=&quot;@name&quot; /&gt;
                        &lt;/div&gt;
                      &lt;/xsl:when&gt;
                      &lt;xsl:when test=&quot;@name = 'BASIC'&quot;&gt;
                        &lt;div class=&quot;alert alert-info&quot; role=&quot;alert&quot;&gt;
                          &lt;xsl:value-of select=&quot;@name&quot; /&gt;
                        &lt;/div&gt;
                      &lt;/xsl:when&gt;
                      &lt;xsl:otherwise&gt;
                        &lt;div class=&quot;alert alert-danger&quot; role=&quot;alert&quot;&gt;
                          &lt;xsl:value-of select=&quot;@name&quot; /&gt;
                        &lt;/div&gt;
                      &lt;/xsl:otherwise&gt;
                    &lt;/xsl:choose&gt;
                  &lt;/td&gt;
                &lt;/tr&gt;
              &lt;/xsl:for-each&gt;
            &lt;/xsl:for-each&gt;
          &lt;/tbody&gt;
        &lt;/table&gt;
      &lt;/body&gt;
    &lt;/html&gt;
  &lt;/xsl:template&gt;
&lt;/xsl:stylesheet&gt;
</code></pre>

<p>Example of the rendering:</p>
<p><img alt="RenderingExample" src="../../assets/Authorization_Testing_Automation_AutomationRendering.png" /></p>
<h1 id="sources-of-the-prototype">Sources of the prototype<a class="headerlink" href="#sources-of-the-prototype" title="Permanent link">&para;</a></h1>
<p><a href="https://github.com/righettod/poc-authz-testing">Github repository</a></p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../Bean_Validation_Cheat_Sheet/" class="btn btn-neutral float-right" title="Bean Validation Cheat Sheet">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../Authentication_Cheat_Sheet/" class="btn btn-neutral" title="Authentication Cheat Sheet"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../Authentication_Cheat_Sheet/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../Bean_Validation_Cheat_Sheet/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(false);
        };
    </script>

</body>
</html>
